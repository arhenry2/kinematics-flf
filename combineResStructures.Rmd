---
title: "Combine Res Structures"
output: html_document
---

```{r setup, include=FALSE}
### Gets flf package loaded into environment ###
# install.packages("backports")
# install.packages("rcmdcheck")
# install.packages("devtools")
# install.packages("rowr")
# install.packages("plotly")
# setwd("/Users/ashleyhenry/")
devtools::load_all('/Users/ashleyhenry/flf')
library(flf)
library(ggplot2)
library(plotly)
library(tidyverse)
library(readr)
library(rowr)
require(reshape2)
library(dplyr)
```

```{r TESTLoad-and-Combine_Res_Structure}
# Loads desired res structure into environment
foo <- load("/Users/ashleyhenry/Desktop/Research/Kinematics/RCodeForExperiments/res_SlowFastRILs.RData")
foo = get(foo)
fah <- load("/Users/ashleyhenry/Desktop/Research/Kinematics/RCodeForExperiments/res_Cvi_2019vsRILPop.RData")
fah = get(fah)

foofah = rbind(foo, fah)

```

```{r Load-Res-Structures}
# Iteratively loads in all res structures from ~/kinematics-flf directory by:
## Loads RData file into new environment
## Then extracts res variable
loadRData <- function(fileName) {
  #loads an RData file, and returns it
  e1 = new.env()
  load(fileName, e1)
  get("res", e1)
}

# Pulls filenames from directory
fils <- matrix(list.files("~/kinematics-flf", pattern="RData$", full.names = TRUE, recursive = TRUE))
# Loading them into RES structure
RES <- lapply(fils, loadRData)

# Save all that hard work, yeah
save(RES, file = "2020_04_29_allresStructures.RData")

# Old way of loading in one res strucutre at a time (aka manually)
## Don't do this, please, or Julian will get, like, really mad
CviLerRILs1_10 <- load("~/kinematics-flf/res_CviLer_RILs_1-10_1.RData")
CviLerRILs1_10 = get(CviLerRILs1_10)
```

```{r Combine-Summary-Tables-of-Res-Structure}
# Goal: Separate summary table & rawData from res structure to make 2 separate dataframes
# Used Julian's code from ParameterInvestigation.Rmd, including function & for loop [below]
## Then rbind() all created summary tables
## TRICK: rbind() should be done in for loop... (work on this!)

############## function & for loop written on 30 January 2020 w/ Julian's help #############
####################### Taken from ParameterInvestigation.Rmd script #######################
# Function to separate res structure and rename pathname to filename for column "fileName" #
pathname_to_filename = function(genotype) {
  # Get genotype name from pathname
  genoName = basename(dirname(dirname(toString(genotype$fileName[[1]]))))
  # Create empty matrix of one column and as many rows as there are of res structure
  outnames = matrix(1, nrow(genotype))
  # Loops through each row of res
  ## Extracts pathname from each row in the dataframe
  ## Extracts filename from each pathname
  ## outnames = extracted filenames
  for (i in 1:nrow(genotype)) {
    namePlay_i  = toString(genotype$fileName[[i]])
    outnames[i] = basename(dirname(namePlay_i))
    print(outnames[i])
  }
  # Replaces pathname column with outnames column
  ## Now the column labeled "fileName" has filename instead of pathname
  genotype[["fileName"]] <- outnames
  # Return genotype summary table and genotype name
  gtype_gname = list(genotype, genoName)
  return(gtype_gname)
}

extractParameters = function(res) {
  # Create empty dataframe to fill with RIL Parameter Summary Tables
  RILParameterSummaryTable = data.frame(matrix(
                                            ncol = 6, 
                                            nrow = 0, 
                                            dimnames = list(NULL, c("fileName", "x0", "vf", "k", "n", "mle"))))

  # For loop to call "pathname_to_filename" function for each genotype in res
  ## Fills dataframe with all replicates of all RILs' parameter summary tables
  for (i in 1:length(res)) {
    gtype = res[[i]]$summary_table
    gList = pathname_to_filename(gtype)
    summaryTable = gList[[1]]
    eval(parse(text = paste0(sprintf("%s = gList[[1]]", gList[[2]]))))
    RILParameterSummaryTable = rbind(RILParameterSummaryTable, summaryTable)
  }

  return(RILParameterSummaryTable)
}

# Uses function above to make summary table for parameters of all RILs
RILParams = lapply(RES, extractParameters)
RILParam_concatenated = bind_rows(RILS)

# Save progress
save(RILParam_concatenated, file = "2020_04_29_RILsSummaryParameters")



##################### Archive #######################
##### The Original Way of Doing the Above Work^ #####
# Create empty dataframe to fill with RIL Parameter Summary Tables
RILParameterSummaryTable = data.frame(matrix(
                                            ncol = 6, 
                                            nrow = 0, 
                                            dimnames = list(NULL, c("fileName", "x0", "vf", "k", "n", "mle"))))

# For loop to call "pathname_to_filename" function for each genotype in res
## Fills dataframe with all replicates of all RILs' parameter summary tables
for (i in 1:length(res)) {
  gtype = res[[i]]$summary_table
  gList = pathname_to_filename(gtype)
  summaryTable = gList[[1]]
  eval(parse(text = paste0(sprintf("%s = gList[[1]]", gList[[2]]))))
  RILParameterSummaryTable = rbind(RILParameterSummaryTable, summaryTable)
}

# Badabing badaboom, combined & saved parameter summary tables
save(RILParameterSummaryTable, file = "RILParameterSummaryTable_CviLerRILs1_10.RData")
```

```{r Average-Parameters-by-RIL}
# This code chunk is to average parameters per RIL to create a table for the input of the R/qtl2 package
## Uses output from above code chunk "Combine-Summary-Tables-of-Res-Structure" ^

# Start with file you just created (^), need to load() then get() to have in environment
AllRILs_SummaryParameters = load("~/rildata/2020_04_29_RILsSummaryParameters")
AllRILs_SummaryParameters = get(AllRILs_SummaryParameters)


# Info from RILs:
mean() # average of that RIL's parameter
sd() # st dev of that RIL's parameter
var() # variance of that RIL's parameter
sum() # No. of samples for that RILs


# could use aggregate() function to create subset of data, calc stats on that, then returns in convenient format
## This is organizing the data alphabetically, but not calc'ing stats and removes fileName... 
tst = aggregate(AllRILs_SummaryParameters, by = list(AllRILs_SummaryParameters$fileName),
             mean, na.rm = TRUE)
# Doesn't work & now I'm confused...
tst2 = aggregate(AllRILs_SummaryParameters,
                by = list(AllRILs_SummaryParameters$fileName),
                FUN = mean)

# Trying a third method, as suggested by someone on StackOverflow
## This isn't grouping, just takes the mean of each RIL sample... ugh
#### It's doing this b/c each name is different...
# Need to extract just the RIL number from each sample, then can group & take average
 
# Example from StackOverflow
longyear = "Y.1992.a1"
year = gsub("^.\\.(\\d+)\\..*", "\\1", longyear)

longname = "RILpop--RIL10--RIL10_001_3.5--"
longname = "RIL30--RIL1_011_2--"
longname = "FastRILs--RIL137_01--"
name2 = str_extract(longname, "[A-Z]+[0-9]+") # this works on all but Cvi/Ler!!!

# Now make a column of shortened RIL names
AllRILs_SummaryParameters$RILs <- AllRILs_SummaryParameters$fileName # Make copy of fileName column called RILs
# Using gsub() here
# AllRILs_SummaryParameters$RILs <- gsub("[A-Z]+[0-9]+", "\\1", AllRILs_SummaryParameters$RILs)


AllRILs_SummaryParameters$RILs <- str_extract(AllRILs_SummaryParameters$RILs, "[A-Z]+[0-9]+") # THIS ONE WORKS, FLIPPING FINALLY!!! WOOOOOOOTTTTTT!!!! now just need to correct for Cvi & Ler
# Filter out NAs (Cvi & Ler)


var = strsplit(AllRILs_SummaryParameters$fileName, split = "--", fixed = TRUE)

AllRILs_SummaryParameters$RILs[is.na(AllRILs_SummaryParameters$RILs)]

year = gsub("^.\\.(\\d+)\\..*", "\\1", longyear)


# Try above method with strsplit()
## Doesn't work, just continues with Cvi like an idiot...
AllRILs_SummaryParameters$RILs <- unlist(strsplit(AllRILs_SummaryParameters$RILs, split = '_', fixed = TRUE))[1]
AllRILs_SummaryParameters$RILs <- unlist(strsplit(AllRILs_SummaryParameters$RILs, split = '--', fixed = TRUE))[2]




# Regular expression practice, need to extract just RIL## & Cvi/Ler from each of these
## This works! Splits the string into parts according to separator & selects the 1st (s1) or 2nd (s2) part of the string (as shown in [] brackets at end of line)
s = "RIL1--RIL1_011_2--"
s = "RILpop--RIL10--RIL10_001_3.5--"
s = "FastRILs--RIL137_01--"
s = "RILpop--Cvi--Cvi_001_3--"
s1 = unlist(strsplit(s, split = '_', fixed = TRUE))[1]
s2 = unlist(strsplit(s1, split = '--', fixed = TRUE))[2] #this works!!!

# Trying gsub again, because strpslip will only take first element and fill in whole column with that 1st element's shortened name




# Now to make new column w/ just RIL Number & Cvi/Ler
# This chops the name correctly, but is only chopping "Cvi" for every sample
AllRILs_SummaryParameters$RILs <- unlist(strsplit(AllRILs_SummaryParameters$fileName, split = '_', fixed = TRUE))[1]

AllRILs_SummaryParameters$RILs <- unlist(strsplit(AllRILs_SummaryParameters$RILs, split = '--', fixed = TRUE))[2]










# Aggregation to happen soon [4.30.2020]
AllRILs_SummaryParameters %>% 
    group_by(fileName) %>% #grouped by RIL variable
    summarise_each(funs(mean = mean(vf, na.rm = TRUE)))
    summarise_each(funs(mean = mean(., na.rm = TRUE)))


```









